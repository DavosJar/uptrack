@startuml Flujo de Monitoreo - UpTrackAI
title Flujo de Ejecución de Monitoreo y Alertas (Arquitectura Polling)

start

partition "Polling Scheduler (Master Loop)" {
    :Ticker (Cada 10s);
    
    if (¿Tengo acceso a Internet?) then (No / Network Error)
        :Loguear "SELF-DOWN: Sin Ping a Google/Cloudflare;
        :Pausar Scheduling (Abortar Ciclo);
        note right #Red
            CIRCUIT BREAKER:
            Evitar falsos positivos masivos.
            Si yo estoy mal, no juzgo a los demás.
        end note
        stop
    else (Sí / Conectado)
        :Continuar...;
    endif

    :Query DB: Obtener Targets Vencidos;
    note right
        SELECT WHERE next_check_at <= NOW()
    end note
    
    :Filtro de Memoria (In-Flight Map);
    note right
        Ignorar si el target ya está siendo
        procesado actualmente
    end note
    
    :Encolar Trabajo en WorkerPool;
}

partition "Worker Execution (Thread Pool)" {
    :Recibir Target del Queue;
    
    :Ejecutar Health Check;
    note right: HTTP Request / Ping ICMP

    :Calcular Métricas;
    :Analizar Cambio de Estado;
    
    if (¿Estado cambió?) then (Sí)
        note right: Transición Detectada (ej. UP -> DOWN)
        
        fork
            partition "Notificación (Prioridad)" {
                :Generar Evento de Alerta;
                :Despachar al Bus de Eventos (Async);
                note right
                    No bloquea la persistencia.
                    Sale inmediato.
                end note
            }
        fork again
            partition "Persistencia (DB)" {
                :Actualizar Target (Status, NextCheck);
                :Registrar CheckResult (Historial);
                :Guardar Métricas (TimeSeries);
            }
        end fork
        
    else (No / Estable)
        :Actualizar LastCheckedAt;
        :Guardar solo Métricas;
    endif
    
    :Invocar Callback (ProcessingComplete);
    :Liberar Lock en Scheduler;
}

stop

@enduml
