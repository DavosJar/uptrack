# AplicaciÃ³n MÃ³vil

UpTrack Mobile es una aplicaciÃ³n nativa construida con React Native y Expo, diseÃ±ada para consulta rÃ¡pida del estado de los sistemas monitoreados desde dispositivos Android e iOS.

## CaracterÃ­sticas Principales

| CaracterÃ­stica | DescripciÃ³n |
|---------------|-------------|
| **Dashboard** | Vista general con estadÃ­sticas y alertas activas |
| **Lista de Sistemas** | Todos los targets con filtros por estado |
| **Detalle de Target** | MÃ©tricas, historial y configuraciÃ³n |
| **Widget Android** | Widget nativo para pantalla de inicio |
| **Notificaciones Push** | Alertas en tiempo real (futuro) |
| **Modo Offline** | CachÃ© local con AsyncStorage |

## Stack TecnolÃ³gico

| CategorÃ­a | TecnologÃ­a | VersiÃ³n |
|-----------|-----------|---------|
| Framework | React Native | 0.81 |
| Plataforma | Expo | 54 |
| Lenguaje | TypeScript | 5.9 |
| UI | React Native SVG | 15.12 |
| Storage | AsyncStorage | 2.2 |
| Widgets | react-native-android-widget | 0.20 |
| Runtime | React | 19.1 |

## Estructura del Proyecto

```
up-track-mobile/
â”œâ”€â”€ App.tsx                 # Punto de entrada
â”œâ”€â”€ app.json               # ConfiguraciÃ³n Expo
â”œâ”€â”€ eas.json               # ConfiguraciÃ³n EAS Build
â”œâ”€â”€ index.ts               # Registro de la app
â”œâ”€â”€ package.json           # Dependencias
â”œâ”€â”€ tsconfig.json          # ConfiguraciÃ³n TypeScript
â”œâ”€â”€ assets/                # Iconos y splash screens
â””â”€â”€ src/
    â”œâ”€â”€ api/
    â”‚   â”œâ”€â”€ config.ts      # URL base del API
    â”‚   â””â”€â”€ fetch.ts       # Cliente HTTP con auth
    â”œâ”€â”€ components/
    â”‚   â”œâ”€â”€ BottomTabBar.tsx
    â”‚   â””â”€â”€ Layout.tsx
    â”œâ”€â”€ context/
    â”‚   â””â”€â”€ AuthContext.tsx # GestiÃ³n de sesiÃ³n
    â”œâ”€â”€ navigation/
    â”‚   â””â”€â”€ AppNavigator.tsx # NavegaciÃ³n entre pantallas
    â”œâ”€â”€ screens/
    â”‚   â”œâ”€â”€ LoginScreen.tsx
    â”‚   â”œâ”€â”€ DashboardScreen.tsx
    â”‚   â”œâ”€â”€ SystemsScreen.tsx
    â”‚   â”œâ”€â”€ TargetDetailsScreen.tsx
    â”‚   â”œâ”€â”€ AddTargetScreen.tsx
    â”‚   â”œâ”€â”€ SettingsScreen.tsx
    â”‚   â”œâ”€â”€ NotificationsScreen.tsx
    â”‚   â””â”€â”€ WidgetConfigScreen.tsx
    â”œâ”€â”€ theme/
    â”‚   â””â”€â”€ colors.ts      # Paleta de colores
    â””â”€â”€ widgets/
        â”œâ”€â”€ SystemStatusWidget.tsx
        â””â”€â”€ widget-task-handler.tsx
```

## Arquitectura de ComunicaciÃ³n

El siguiente diagrama ilustra la arquitectura de comunicaciÃ³n entre la aplicaciÃ³n mÃ³vil y el backend:

![Arquitectura Mobile-Backend](./diagramas/Arquitectura-mobile-backend.png)

## Sistema de NavegaciÃ³n

La aplicaciÃ³n utiliza un sistema de navegaciÃ³n basado en estado (sin React Navigation para mantener el bundle ligero):

```tsx
// AppNavigator.tsx
type Screen = TabScreen | 'addTarget' | 'targetDetails' | 'notifications' | 'widgetConfig';

const AppNavigator: React.FC = () => {
  const { isLoggedIn, loading } = useAuth();
  const [currentScreen, setCurrentScreen] = useState<Screen>('dashboard');
  const [selectedTargetId, setSelectedTargetId] = useState<string | null>(null);

  // NavegaciÃ³n condicional basada en autenticaciÃ³n
  if (!isLoggedIn) {
    return <LoginScreen />;
  }

  // Renderizado de pantalla actual
  switch (currentScreen) {
    case 'dashboard':
      return <DashboardScreen onNavigateToDetails={navigateToDetails} />;
    case 'systems':
      return <SystemsScreen onNavigateToDetails={navigateToDetails} />;
    // ...
  }
};
```

### Pantallas Disponibles

| Pantalla | Tab | DescripciÃ³n |
|----------|-----|-------------|
| `LoginScreen` | - | AutenticaciÃ³n de usuario |
| `DashboardScreen` | ðŸ  | EstadÃ­sticas y alertas activas |
| `SystemsScreen` | ðŸ“Š | Lista completa de targets |
| `TargetDetailsScreen` | - | Detalle con mÃ©tricas de un target |
| `AddTargetScreen` | - | Formulario para crear target |
| `SettingsScreen` | âš™ï¸ | ConfiguraciÃ³n de la app |
| `NotificationsScreen` | - | Preferencias de notificaciones |
| `WidgetConfigScreen` | - | ConfiguraciÃ³n del widget |

## Cliente API

El cliente HTTP centraliza la autenticaciÃ³n usando AsyncStorage:

```typescript
// api/fetch.ts
export async function fetchWithAuth(url: string, options: RequestInit = {}) {
  const token = await AsyncStorage.getItem('token');
  
  // Cache busting para peticiones GET
  const method = options.method?.toUpperCase() || 'GET';
  let finalUrl = url;
  
  if (method === 'GET') {
    const separator = url.includes('?') ? '&' : '?';
    finalUrl = `${url}${separator}_t=${Date.now()}`;
  }

  const response = await fetch(`${API_BASE_URL}${finalUrl}`, {
    ...options,
    headers: {
      ...options.headers,
      'Authorization': `Bearer ${token}`,
    },
  });

  // Logout automÃ¡tico si el token expirÃ³
  if (response.status === 401) {
    await AsyncStorage.removeItem('token');
    throw new Error('Unauthorized');
  }

  return response;
}
```

## Contexto de AutenticaciÃ³n

GestiÃ³n de sesiÃ³n mediante React Context y AsyncStorage:

```tsx
// context/AuthContext.tsx
interface AuthContextType {
  isLoggedIn: boolean;
  token: string | null;
  loading: boolean;
  login: (token: string) => Promise<void>;
  logout: () => Promise<void>;
}

export const AuthProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [token, setToken] = useState<string | null>(null);

  // Verificar token almacenado al iniciar
  useEffect(() => {
    const checkAuth = async () => {
      const storedToken = await AsyncStorage.getItem('token');
      if (storedToken) {
        setToken(storedToken);
        setIsLoggedIn(true);
      }
    };
    checkAuth();
  }, []);

  const login = async (newToken: string) => {
    await AsyncStorage.setItem('token', newToken);
    setToken(newToken);
    setIsLoggedIn(true);
  };

  const logout = async () => {
    await AsyncStorage.removeItem('token');
    setToken(null);
    setIsLoggedIn(false);
  };
};
```

## Widget Android

La aplicaciÃ³n incluye un widget nativo para Android que muestra el estado de un sistema seleccionado:

```tsx
// widgets/SystemStatusWidget.tsx
interface SystemStatusWidgetProps {
  systemName: string;
  status: 'UP' | 'DOWN' | 'PENDING' | 'UNKNOWN';
  lastChecked: string;
  responseTime: number | null;
}

export function SystemStatusWidget({
  systemName,
  status,
  lastChecked,
  responseTime,
}: SystemStatusWidgetProps) {
  return (
    <FlexWidget
      style={{
        backgroundColor: '#1E293B',
        borderRadius: 16,
        padding: 16,
      }}
      clickAction="OPEN_APP"
    >
      <TextWidget text={systemName} />
      <TextWidget 
        text={getStatusText(status)} 
        style={{ color: getStatusColor(status) }}
      />
      <TextWidget text={`Ãšltimo check: ${lastChecked}`} />
      {responseTime && (
        <TextWidget text={`${responseTime}ms`} />
      )}
    </FlexWidget>
  );
}
```

### CaracterÃ­sticas del Widget

- **TamaÃ±o**: 2x1 celdas mÃ­nimo
- **ActualizaciÃ³n**: PeriÃ³dica o por evento
- **AcciÃ³n**: Abre la app al tocar
- **Tema**: Oscuro para mejor visibilidad

## Tema y Colores

Paleta de colores consistente con la versiÃ³n web:

```typescript
// theme/colors.ts
export const colors = {
  // Backgrounds
  background: '#0F172A',
  backgroundCard: '#1E293B',
  backgroundInput: '#334155',
  
  // Text
  textMain: '#F8FAFC',
  textMuted: '#94A3B8',
  
  // Status
  statusSuccess: '#22C55E',  // UP - Verde
  statusDanger: '#EF4444',   // DOWN - Rojo
  statusWarning: '#F59E0B',  // DEGRADED - Amarillo
  statusInfo: '#3B82F6',     // Primary - Azul
  
  // UI
  primary: '#3B82F6',
  border: '#334155',
};
```

## ConfiguraciÃ³n de Expo

```json
// app.json
{
  "expo": {
    "name": "UpTrack",
    "slug": "up-track-mobile",
    "version": "1.0.0",
    "orientation": "portrait",
    "icon": "./assets/icon.png",
    "splash": {
      "image": "./assets/splash-icon.png",
      "backgroundColor": "#0F172A"
    },
    "ios": {
      "supportsTablet": true,
      "bundleIdentifier": "com.uptrack.mobile"
    },
    "android": {
      "adaptiveIcon": {
        "foregroundImage": "./assets/adaptive-icon.png",
        "backgroundColor": "#0F172A"
      },
      "package": "com.uptrack.mobile"
    }
  }
}
```

## Desarrollo Local

### Requisitos

- Node.js 18+
- pnpm (recomendado)
- Expo CLI
- Android Studio / Xcode (para emuladores)
- Expo Go app (para dispositivo fÃ­sico)

### InstalaciÃ³n y EjecuciÃ³n

```bash
# Instalar dependencias
cd up-track-mobile
pnpm install

# Iniciar servidor de desarrollo
pnpm start

# Ejecutar en Android
pnpm android

# Ejecutar en iOS
pnpm ios

# Ejecutar en navegador web
pnpm web
```

### ConfiguraciÃ³n del API

La aplicaciÃ³n requiere configurar la URL base del backend en `src/api/config.ts`. Debido a las restricciones de seguridad de Android/iOS (que bloquean http plano por defecto) y para facilitar las pruebas en dispositivos fÃ­sicos, se recomienda encarecidamente el uso de **ngrok**.

#### Uso de Ngrok (Recomendado)

Ngrok crea un tÃºnel seguro (HTTPS) desde internet hacia tu servidor local, permitiendo que el dispositivo mÃ³vil acceda al backend sin problemas de red o certificados.

1.  **Iniciar Backend:** AsegÃºrate que tu backend corre en el puerto 8080.
2.  **Iniciar Ngrok:** Ejecuta el siguiente comando en una terminal:
    ```bash
    ngrok http 8080
    ```
3.  **Configurar App:** Copia la URL HTTPS generada (ej. `https://xxxx-xxxx.ngrok-free.app`) en `src/api/config.ts`:

```typescript
// src/api/config.ts

// RECOMENDADO: URL de Ngrok (http & https tunnels)
// Permite testing en dispositivo fÃ­sico sin configurar Cleartext Traffic
export const API_BASE_URL = 'https://tu-id-ngrok.ngrok-free.app';

/* Otras configuraciones:
// Localhost (Solo Emulador Android)
// export const API_BASE_URL = 'http://10.0.2.2:8080';

// IP Local (Requiere estar en la misma red WiFi)
// export const API_BASE_URL = 'http://192.168.1.X:8080';
*/
```

> **Nota:** La versiÃ³n gratuita de ngrok cambia la URL cada vez que se reinicia. Recuerda actualizar `config.ts` al obtener una nueva URL.

## Build de ProducciÃ³n

### EAS Build (Recomendado)

```bash
# Instalar EAS CLI
npm install -g eas-cli

# Login en Expo
eas login

# Build para Android (APK)
eas build --platform android --profile preview

# Build para iOS
eas build --platform ios --profile preview

# Build de producciÃ³n
eas build --platform all --profile production
```

### ConfiguraciÃ³n EAS (eas.json)

```json
{
  "build": {
    "preview": {
      "distribution": "internal",
      "android": {
        "buildType": "apk"
      }
    },
    "production": {
      "android": {
        "buildType": "app-bundle"
      }
    }
  }
}
```

## Funcionalidades Futuras

| Funcionalidad | Estado | DescripciÃ³n |
|--------------|--------|-------------|
| Push Notifications | ðŸ”œ Planificado | Alertas en tiempo real vÃ­a Firebase/APNs |
| Widget iOS | ðŸ”œ Planificado | Widget para pantalla de inicio iOS |
| Modo Offline | ðŸ”œ Planificado | CachÃ© completo con sincronizaciÃ³n |
| BiometrÃ­a | ðŸ”œ Planificado | AutenticaciÃ³n con huella/Face ID |
| Deep Links | ðŸ”œ Planificado | Abrir target especÃ­fico desde notificaciÃ³n |
